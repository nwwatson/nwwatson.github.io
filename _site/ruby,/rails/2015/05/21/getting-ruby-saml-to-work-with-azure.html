<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Getting ruby-saml to work with Azure AD &vert; Nicholas W. Watson</title>
<meta name="description" content="Dymistify the processes of authenticating Azure AD.
">
<meta name="keywords" content="">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://localhost:4000/images/">
<meta name="twitter:title" content="Getting ruby-saml to work with Azure AD">
<meta name="twitter:description" content="Dymistify the processes of authenticating Azure AD.
">
<meta name="twitter:creator" content="@nwwatson">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Getting ruby-saml to work with Azure AD">
<meta property="og:description" content="Dymistify the processes of authenticating Azure AD.
">
<meta property="og:url" content="http://localhost:4000/ruby,/rails/2015/05/21/getting-ruby-saml-to-work-with-azure.html">
<meta property="og:site_name" content="Nicholas W. Watson">

<meta property="og:image" content="http://localhost:4000/images/">




<link rel="canonical" href="http://localhost:4000/ruby,/rails/2015/05/21/getting-ruby-saml-to-work-with-azure.html">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Nicholas W. Watson Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<link href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/pure-min.css" integrity="sha384-" crossorigin="anonymous">

<!--[if lte IE 8]>
    <link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/grids-responsive-old-ie-min.css">
<![endif]-->
<!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/grids-responsive-min.css">
<!--<![endif]-->

<link rel="stylesheet" href="http://localhost:4000/assets/css/styles.css">

</head>
<body class="home-template" itemscope itemtype="http://schema.org/WebPage">

  <div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
      <h1 class="brand-title"><a class="brand-link" href="/">Nicholas Watson</a></h1>
      <h2 class="brand-tagline">Technology, software, development.</h2>

      <nav class="nav">
          <ul class="nav-list">

          </ul>
      </nav>
  </div>
</div>

    <div class="content pure-u-1 pure-u-md-3-4">
      <!-- A single blog post -->
    	<section class="post">
    		<header class="post-header">
    			<div class="date">
    				<time datetime="2015-05-21T19:57:00-04:00"><span class="day">21</span> <span class="month-year">May 2015</span></time>
    			</div>

    			<h2>
    				<a href="http://localhost:4000">
    						Getting ruby-saml to work with Azure AD
    				</a>
    			</h2>
    			<p class="post-meta">
    				<a class="post-category post-category-pure" href="#" title="Other posts from the Ruby, category">Ruby,</a>&nbsp;<a class="post-category post-category-pure" href="#" title="Other posts from the Rails category">Rails</a>
    			</p>
    		</header>

    			<div class="post-description">
    				<p>I’m going to make this short and sweet. So you’ve been tasked with using SAML to authenticate users with  Azure AD. Sure, there are other mechanisms available, but this client wants SAML. No problem. Knowning nothing about AD or SAML, but having some experience with OAuth, you think “This couldn’t be that hard”. Then you find out SAML 2.0 is a little more complicated than OAuth.</p>

<p>I’m not going to walk you though a example on how to build. There are examples available, specifically <a href="https://github.com/onelogin/ruby-saml-example">ruby-saml-example</a>. I’ll use this to properly show you how to configure Azure AD.</p>

<h2 id="signup-for-an-azure-account">Signup for an Azure account</h2>

<p>While I’m happy to write this quick tutorial, I’m not going to walk you through create an Azure account. Its self explanitory. You can do it.</p>

<h2 id="create-an-active-directory">Create an Active Directory</h2>

<h2 id="add-an-application">Add an Application</h2>

<h2 id="configure-ruby-saml-settings">Configure ruby-saml Settings</h2>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code>  <span class="n">idp_metadata_parser</span> <span class="o">=</span> <span class="no">OneLogin</span><span class="o">::</span><span class="no">RubySaml</span><span class="o">::</span><span class="no">IdpMetadataParser</span><span class="p">.</span><span class="nf">new</span>
  <span class="c1"># This does all the hard work. it grabs the federation metadata from Azure</span>
  <span class="n">settings</span> <span class="o">=</span> <span class="n">idp_metadata_parser</span><span class="p">.</span><span class="nf">parse_remote</span><span class="p">(</span><span class="s2">"https://login.microsoftonline.com/FunnyImNotGivingYouThis/federationmetadata/2007-06/federationmetadata.xml"</span><span class="p">)</span>
  
  <span class="c1"># This is the URL that Azure AD calls back after a successful login</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">assertion_consumer_service_url</span> <span class="o">=</span> <span class="s2">"http://localhost:3000/saml/acs"</span>
  
  <span class="c1"># This URL will be calledback after a logout event</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">assertion_consumer_logout_service_url</span> <span class="o">=</span> <span class="s2">"http://localhost:3000/saml/logout"</span>
  
  <span class="c1"># Microsoft calls this the Client ID. Copy it from your application's </span>
  <span class="c1"># properties in Azure and drop it here.</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">issuer</span> <span class="o">=</span> <span class="s2">"55555555-5555-5555-5555-555555555555"</span>
  
  <span class="c1"># You need to copy the  X509 certificate out of the &lt;ds:Signature&gt; node of the</span>
  <span class="c1"># federation metadata xml file. Then go to https://www.samltool.com/fingerprint.php</span>
  <span class="c1"># and paste it in to the x509 cert field. Use the Formatted Fingerprint in the line </span>
  <span class="c1"># below</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">idp_cert_fingerprint</span> <span class="o">=</span> <span class="s2">"It:Is:So:me:Th:in:gL:ik:eT:hi:sB:ut:Re:al"</span>
  
  <span class="c1"># You shouldn't have to change this line. Works like a champ.</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">name_identifier_format</span> <span class="o">=</span> <span class="s2">"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress"</span>
</code></pre>
</div>


    			</div>
    	</section>


      
      <div class="cf"></div>
      
        <section class="notepad-disqus row">
          <div class="small-12 columns">
            <h1 class="notepad-comments-header">Comments</h1>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'nicholaswatson'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          </div>
        </section>
      
  </div>
</div>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57714341-1', 'auto');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>


</body>
</html>
